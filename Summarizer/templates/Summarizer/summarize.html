{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>SmartChatter</title>
  <meta name="csrf-token" content="{{ csrf_token }}">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            "nude-purple": "#C9A6D3",
            "nude-blue": "#9AC6F2"
          }
        }
      }
    }
  </script>
</head>
<body class="bg-gray-900 text-gray-200 font-sans min-h-screen p-6">
<div class="max-w-5xl mx-auto space-y-8">

  {# ---------------------- FILE-UPLOAD / SUMMARIZE VIEW ---------------------- #}
  {% if view_mode == "summarize" %}
  <section class="bg-gray-800 rounded-2xl shadow-lg p-6">
    <h2 class="text-2xl font-bold text-nude-purple mb-4">Upload Files to Summarize</h2>
    <form id="summary-form" enctype="multipart/form-data" class="space-y-4">
      <input type="file" name="files" id="file-input" multiple required
             class="block w-full text-sm text-gray-400 border border-gray-700 rounded-lg cursor-pointer bg-gray-700 focus:outline-none" />
      <button type="submit" 
              class="px-4 py-2 bg-nude-purple text-gray-900 font-semibold rounded-lg hover:bg-nude-blue transition">
        Summarize
      </button>
    </form>
    <h3 class="text-lg mt-6 mb-2">Combined Summary:</h3>
    <div id="summary-output" 
         class="bg-gray-900 border border-gray-700 rounded-lg p-4 font-mono text-sm whitespace-pre-wrap"></div>
  </section>

  <!-- Email Section (hidden until summary) -->
  <section id="email-section" class="bg-gray-800 rounded-2xl shadow-lg p-6 hidden">
    <h3 class="text-xl font-semibold text-nude-purple mb-4">Send Summary via Email</h3>
    <form id="send-email-form" class="space-y-4">
      <label for="recipient-dropdown" class="block">Select recipient:</label>
      <select id="recipient-dropdown" name="email" required
              class="block w-full bg-gray-700 border border-gray-600 rounded-lg p-2 text-gray-200"></select>
      <input type="hidden" name="file_title" id="file-title-input" />
      <button type="submit" 
              class="px-4 py-2 bg-nude-purple text-gray-900 font-semibold rounded-lg hover:bg-nude-blue transition">
        Send Email
      </button>
    </form>
    <div id="email-status" style="margin-top:10px; font-weight:bold; color:blue;"></div>
  </section>
  {% endif %}

  {# ---------------------- DATABASE VIEW ---------------------- #}
  {% if view_mode == "chatbot" %}
  <section class="bg-gray-800 rounded-2xl shadow-lg p-6">
    <h2 class="text-2xl font-bold text-nude-purple mb-4">Upload File to Database</h2>
    <form id="db-file-upload-form" enctype="multipart/form-data" class="space-y-4">
      <input type="file" name="db_files" id="db-file-input" accept=".txt,.pdf,.docx" multiple required
             class="block w-full text-sm text-gray-400 border border-gray-700 rounded-lg cursor-pointer bg-gray-700 focus:outline-none" />
      <button type="submit" 
              class="px-4 py-2 bg-nude-purple text-gray-900 font-semibold rounded-lg hover:bg-nude-blue transition">
        Upload File to DB
      </button>
    </form>
    <p id="db-upload-status" class="mt-3 text-sm"></p>
  </section>

  <section class="bg-gray-800 rounded-2xl shadow-lg p-6 mt-6">
    <h2 class="text-2xl font-bold text-nude-purple mb-4">Ask a Question</h2>
    <form id="semantic-form" class="space-y-4">
      <textarea name="semantic-question" id="semantic-question-input" required
                class="block w-full bg-gray-700 border border-gray-600 rounded-lg p-3 text-gray-200 placeholder-gray-400"
                placeholder="Ask your semantic question..."></textarea>
      <button type="submit" 
              class="px-4 py-2 bg-nude-purple text-gray-900 font-semibold rounded-lg hover:bg-nude-blue transition">
        Ask
      </button>
    </form>
    <pre id="semantic-answer-output" 
         class="bg-gray-900 border border-gray-700 rounded-lg p-4 mt-4 text-sm whitespace-pre-wrap"></pre>
  </section>
  {% endif %}

</div>

<!-- ---------------------- JAVASCRIPT HANDLERS ---------------------- -->
<script src="{% static 'Summarizer/js/summarizer.js' %}"></script>
<script>
const getCSRFToken = () => document.querySelector('meta[name="csrf-token"]').getAttribute('content');

{% if view_mode == "summarize" %}
async function loadRecipients() {
  const dropdown = document.getElementById('recipient-dropdown');
  dropdown.innerHTML = '';
  try {
    const response = await fetch('/ui/get-recipients/');
    const data = await response.json();
    (data.recipients || []).forEach(email => {
      const option = document.createElement('option');
      option.value = email;
      option.textContent = email;
      dropdown.appendChild(option);
    });
  } catch (err) {
    console.error("Failed to load recipients", err);
  }
}

// ---------------------- FILE SUMMARIZE HANDLER ----------------------
document.getElementById('summary-form').addEventListener('submit', async e => {
  e.preventDefault();
  const output = document.getElementById('summary-output');
  output.textContent = "Summarizing, please wait...";

  const files = document.getElementById('file-input').files;
  const formData = new FormData();
  for (let i = 0; i < files.length; i++) formData.append('files', files[i]);

  const response = await fetch('/api/summarize-multiple-files/', {
    method: 'POST',
    body: formData,
    headers: { 'X-CSRFToken': getCSRFToken() }
  });

  const data = await response.json();
  output.textContent = data.summary || data.error;

  if (data.summary) {
    document.getElementById('file-title-input').value = data.summary_filename || "summary";
    document.getElementById('email-section').classList.remove("hidden");
    loadRecipients();
  }
});

// ---------------------- SEND EMAIL HANDLER ----------------------
document.getElementById('send-email-form').addEventListener('submit', async e => {
  e.preventDefault();
  const formData = new FormData(e.target);
  const response = await fetch('/api/send-summary-email/', {
    method: 'POST',
    body: formData,
    headers: { 'X-CSRFToken': getCSRFToken() }
  });
  const data = await response.json();
  const statusElem = document.getElementById('email-status');
  if (data.success) {
    statusElem.textContent = "Summary sent successfully!";
    statusElem.className = "mt-3 text-sm text-green-400";
  } else {
    statusElem.textContent = "Failed: " + (data.error || "Unknown error");
    statusElem.className = "mt-3 text-sm text-red-400";
  }
});
{% endif %}

{% if view_mode == "chatbot" %}
// ---------------------- DB UPLOAD HANDLER ----------------------
document.getElementById('db-file-upload-form').addEventListener('submit', async e => {
  e.preventDefault();
  const files = document.getElementById('db-file-input').files;
  const formData = new FormData();
  for (let i = 0; i < files.length; i++) formData.append('db_files', files[i]);

  const response = await fetch('/api/upload-file-to-db/', {
    method: 'POST',
    body: formData,
    headers: { 'X-CSRFToken': getCSRFToken() }
  });

  const data = await response.json();
  const statusElem = document.getElementById('db-upload-status');
  if (data.success) {
    let message = '';
    if (data.inserted?.length) message += `Uploaded: ${data.inserted.join(', ')}. `;
    if (data.skipped?.length) message += `Skipped: ${data.skipped.join(', ')}.`;
    statusElem.textContent = message || "File uploaded to DB!";
    statusElem.className = "mt-3 text-sm text-green-400";
  } else {
    statusElem.textContent = "Failed: " + data.error;
    statusElem.className = "mt-3 text-sm text-red-400";
  }
});

// ---------------------- SEMANTIC SEARCH HANDLER ----------------------
document.getElementById('semantic-form').addEventListener('submit', async e => {
  e.preventDefault();
  const question = document.getElementById('semantic-question-input').value;
  const output = document.getElementById('semantic-answer-output');
  output.textContent = "Thinking...";
  try {
    const response = await fetch('/api/semantic-search/', {
      method: 'POST',
      body: JSON.stringify({ question }),
      headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCSRFToken() }
    });
    const data = await response.json();
    output.textContent = data.answer || data.error;
  } catch (err) {
    output.textContent = "Something went wrong.";
  }
});
{% endif %}
</script>
</body>
</html>
